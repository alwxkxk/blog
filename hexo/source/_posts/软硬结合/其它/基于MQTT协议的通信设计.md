---
title: 基于MQTT协议的通信设计
hidden: true
toc: true
tags:
  - MQTT
abbrlink: 31151
date: 2019-02-03 19:01:21
---

&emsp;__本文阅读需要有MQTT协议基本使用经验。__
&emsp;demo1与demo2都是使用TCP协议通信直接来传数据。在TCP协议基础之上，硬件发给服务器的第一条消息被我们定义成设备ID，后续的所有消息都被定义成实时温度值，而服务器发给硬件的消息里0代表关灯，1代表开灯，这些就是我们基于TCP协议的通信设计。同样的，基于MQTT协议我们也可以设计出类似的自定义通信。下面我们将讨论一下基于MQTT协议的通信设计。

## 硬件之间可直接通信
&emsp;__MQTT协议一大特点是：通过订阅分布的方式，让硬件之间直接通信。__
&emsp;我们先假设出一个简单的物联网系统：当【温度传感器a】检测到大于24度时，打开【空调A】制冷（分开的两个硬件设备，两者通过网络来进行通信）。传统的方案是上传温度值给云服务器后端程序，然后由后端程序进行逻辑判断，若符合条件（大于24度）则找出需要控制的硬件（空调A）并发送控制命令消息，如图所示：
![](/blog_images/005BIQVbgy1fztjc0zj79j30vk0drq37.jpg)
&emsp;但是使用了MQTT协议之后，硬件与硬件之间可以直接通信（由硬件自行订阅相关主题），这就意味着，温度传感器可以直接通知空调要制冷，空调也可以直接获取温度传感器的数值自行判断是否制冷，当然也可以按传统方案来，把判断逻辑与寻找需要控制硬件的工作交由云服务器后端程序负责。
&emsp;将判断逻辑放到传感器：
![](/blog_images/005BIQVbgy1fztjffn300j30ui0da74r.jpg)
&emsp;将判断逻辑放到空调控制器：
![](/blog_images/005BIQVbgy1fztjfmimthj30vd0dvmxe.jpg)
&emsp;传统方案，将判断逻辑放到云服务器后端程序：
![](/blog_images/005BIQVbgy1fztjk3zbpnj30ub0hkjrr.jpg)

&emsp;__新方案相对于传统方案，极其有效地减轻云服务器的压力（把压力转移到客户端上），合理使用将会节约大量的成本。__

## 新方案带来的新问题
&emsp;新方案我并没有实践过，但根据经验，已经能想到它带来的新问题。
- 缺失控制能力
传统方案是经由云服务器后端程序控制的，想拦截部分消息就在后端程序里改改就行了，但新方案是无法拦截的，MQTT网关只是转发消息而已。
- 相对于软件改动，硬件改动成本更大
业务改动了（经常出现），按传统方案改改软件代码（后端程序）就行，新方案就需要直接改动硬件的代码（传感器或空调），改动硬件成本是远远大于改动软件成本，一般万不得已不会乱改动硬件。

## 改进方案
&emsp;上面提到的新方案带来的新问题，改进就需要：1.后端程序能有效控制。2.即使业务改动也不能改动硬件代码。
&emsp;新方案是由传感器直接发布控制空调的消息或者由空调直接订阅传感器的数据，改进方案变成了 __由后端程序决定硬件需要订阅什么消息，如何做判断__。这样改进就能既享受新方案减轻云服务器压力的优点，又避开了新方案带来的新问题。
&emsp;具体做法简单说一下，硬件代码需要写得灵活一些，如：当【空调A】与MQTT服务器建立连接后，马上发送自己的动作列表：“动作1（制冷）、动作2（停止制冷）”，让后端程序获得此设备的动作列表。管理员根据情况，设置【空调A】订阅【温度传感器a】消息，当其值大于24时，就执行动作1（制冷）。
&emsp;由于【空调A】订阅了设置消息，所以就会接收到：“订阅【温度传感器a】消息，当其值大于24时，就执行动作1。”。
&emsp;自此，【空调A】就能自行订阅【温度传感器a】的消息，并自行判断，然后执行相对应的动作。当业务改动时，就由管理员修改设置即可。改进方案能够让后端程序实现有效控制，并且能适应业务改动。当然，硬件代码只能做那些简单的判断，比如说大于、小于、等于、真、假等等这几个判断，更复杂的比如说等待客户支付成功才能打开门这种复杂业务逻辑的，可以由后端代码进行判断然后将结果转换成一条简单的MQTT消息发布出来，设置硬件订阅这条消息的值，真或假即可。
&emsp;__这个改进方案我暂时没见过有人使用，一来这样设计有点新，有点复杂，二来很少物联网系统连接的设备数量达到一定的量级，为了更低的云服务器成本而使用这样相对复杂、开发成本相对较高的方案（具体需要达到多少设备数量时采用这个改进方案比较划算，暂时还缺乏实践数据所以还无法计算）。__ 
&emsp;另外，为了兼容旧硬件，一般会有一个转换网关（在旧硬件与新系统之间的硬件，上面跑着转换代码）。

## 其它问题
&emsp;在工作中，使用MQTT协议时遇见了一些问题：消息爆炸（使用限流算法如：令牌桶算法）、消息重复（注意幂等性）等问题，待我更深入研究后再讨论。



