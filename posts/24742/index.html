<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="生子当如哈士奇的个人博客，包含若干技术文章，以及《软硬结合——从零打造物联网》、《3D可视化教程》两个系列教程。"><meta name="baidu-site-verification" content="xsF0k2IpTd"><meta name="360-site-verification" content="17062a868693e9ab70b4c9543d98059b"><meta name="sogou_site_verification" content="VAcZeTHOK4"><meta name="google-site-verification" content="_1T1ah4LkGnFPqgYs6wQqN27O6PfrXJqG8gbFwh7ClM"><title>亲手实现demo1 | 生子当如哈士奇的个人博客</title><script type="text/javascript" src="/sw-init.js"></script><link rel="stylesheet" type="text/css" href="/blog/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/blog/css/normalize.min.css"><link rel="stylesheet" type="text/css" href="/blog/css/pure-min.css"><link rel="stylesheet" type="text/css" href="/blog/css/grids-responsive-min.css"><link rel="stylesheet" href="/blog/css/font-awesome.min.css"><script type="text/javascript" src="/blog/js/jquery-3.3.1.min.js"></script><script type="text/javascript" src="/blog/js/lazyload.8.16.0.min.js"></script><link rel="stylesheet" type="text/css" href="/blog/css/bootstrap.min.css"><script type="text/javascript" src="/blog/js/bootstrap.min.js"></script><link rel="stylesheet" type="text/css" href="/blog/css/bootstrap-treeview.min.css"><script type="text/javascript" src="/blog/js/bootstrap-treeview.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><link rel="apple-touch-icon" href="/blog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/blog/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '646acd4e6c74eb119c3d5d93c5bfde70';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><link rel="stylesheet" type="text/css" href="/blog/css/index.css"><script type="text/javascript" src="/blog/js/slideout.min.js"></script><script type="text/javascript" src="/blog/js/image-fullscreen.js"></script><meta name="generator" content="Hexo 5.4.1"></head><body><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/blog/js/totop.js?v=0.0.0" async></script><nav class="navbar navbar-default"><div class="container-fluid navbar-custom"><!-- Brand and toggle get grouped for better mobile display--><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="#">导航栏</a></div><!-- Collect the nav links, forms, and other content for toggling--><div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1"><ul class="nav navbar-nav"><li class="dropdown"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">软硬结合——从零打造物联网 <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/44755">导读</a></li><li><a href="/blog/posts/31494">1.NodeMCU基础</a></li><li><a href="/blog/posts/64786">2.demo1跑起来</a></li><li><a href="/blog/posts/64594">3.demo2跑起来</a></li><li><a href="/blog/posts/31687">4.部署到云服务器</a></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">亲手实现demo0.1</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/37707">5.计算机网络基础</a></li><li><a href="/blog/posts/7602">6.NodeMCU与网络调试助手联调</a></li><li><a href="/blog/posts/58215">7.使用NodeJs实现TCP服务器</a></li><li><a href="/blog/posts/54080">8.HTML、CSS、JS基础</a></li><li><a href="/blog/posts/33173">9.使用NodeJs实现HTTP服务器</a></li><li><a href="/blog/posts/38208">10.亲手实现demo0.1     </a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">亲手实现demo1</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/27238">11.Bootstrap基础</a></li><li><a href="/blog/posts/22339">12.Express框架</a></li><li><a href="/blog/posts/24742">13.亲手实现demo1</a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">亲手实现demo2</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/18173">14.数据可视化基础</a></li><li><a href="/blog/posts/21192">15.Websocket协议</a></li><li><a href="/blog/posts/41347">16.数据库基础</a></li><li><a href="/blog/posts/29864">17.亲手实现demo2</a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">其它补充</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/52429">chrome开发者工具</a></li><li><a href="/blog/posts/54436">软硬结合调试技巧</a></li><li><a href="/blog/posts/15341">将demo2制作成微信小程序</a></li><li><a href="/blog/posts/1041">将demo2制作成exe应用程序</a></li><li><a href="/blog/posts/34982">Linux基础</a></li><li><a href="/blog/posts/41995">最后的讨论</a></li></ul></li></ul></li><li class="dropdown"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">3D可视化教程（Web）<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/30679/">导读</a></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">项目示例</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/2544">a-模型拆解示例</a></li><li><a href="/blog/posts/46791">b-智慧城市                 </a></li><li><a href="/blog/posts/19890">c-数据中心</a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">基础示例</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/42378">1-模型制作与展示</a></li><li><a href="/blog/posts/45270">2-模型数据                 </a></li><li><a href="/blog/posts/5988">3-光线痕迹</a></li><li><a href="/blog/posts/60366">4-动画</a></li><li><a href="/blog/posts/52736">5-显示动态图               </a></li><li><a href="/blog/posts/56155">6-屏幕坐标转换</a></li><li><a href="/blog/posts/48386">7-开关门(不动点)              </a></li><li><a href="/blog/posts/30581">8-聚焦靠近</a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">Blender相关</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/46886">常用操作</a></li><li><a href="/blog/posts/20949">导入城市建筑(.osm)                </a></li><li><a href="/blog/posts/4195">导入城市建筑(.rdc)     </a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">其它</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/31929">3D案例收集</a></li><li><a href="/blog/posts/27566">PS常用技巧              </a></li><li><a href="/blog/posts/47064">PS制作科技感界面  </a></li><li><a href="/blog/posts/5200">three.js性能优化</a></li><li><a href="/blog/posts/1192">线性代数基础知识归纳              </a></li><li><a href="/blog/posts/44479">3D温场效果  </a></li><li><a href="/blog/posts/3280">线框转换效果</a></li></ul></li></ul></li><li class="dropdown"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">杂谈<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/62923/">推荐书籍</a></li><li><a href="/blog/posts/61760/">工具推荐</a></li><li><a href="/blog/posts/44837/">人生一百种失败方法</a></li><li><a href="/blog/posts/25883/">分享当面试官的经验</a></li></ul></li><li><a href="/archives">所有文章<span class="sr-only">(current)</span></a></li><li><a href="/blog/posts/23630">关于<span class="sr-only">(current)</span></a></li></ul></div></div></nav><main class="body_container"><header><div id="header"><div class="site-name"><h1 class="hidden">亲手实现demo1</h1><a id="logo">生子当如哈士奇的个人博客</a><p class="description">生子当如哈士奇的个人博客，包含若干技术文章，以及《软硬结合——从零打造物联网》、《3D可视化教程》两个系列教程。</p></div><div id="nav-menu"></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-4-4"><div class="content_container"><div class="post"><h1 class="post-title">亲手实现demo1</h1><div class="post-meta">Jul 25, 2021<span> | </span><span class="category"><a href="/blog/categories/%E8%BD%AF%E7%A1%AC%E7%BB%93%E5%90%88/">软硬结合</a><a href="/blog/categories/%E8%BD%AF%E7%A1%AC%E7%BB%93%E5%90%88/%E9%A1%B9%E7%9B%AE%E6%BC%94%E7%A4%BA/">项目演示</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a class="disqus-comment-count" href="/blog/posts/24742/#vcomment"><span class="valine-comment-count" data-xid="/blog/posts/24742/"></span><span> 条评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E7%AF%87%E8%A7%86%E9%A2%91"><span class="toc-number">1.</span> <span class="toc-text">本篇视频</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E7%AF%87%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9"><span class="toc-number">2.</span> <span class="toc-text">本篇学习内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#demo1%E6%80%BB%E8%A7%88"><span class="toc-number">3.</span> <span class="toc-text">demo1总览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#demo1%E7%95%8C%E9%9D%A2%E4%BB%A3%E7%A0%81"><span class="toc-number">4.</span> <span class="toc-text">demo1界面代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#demo1%E9%87%8CNodeMCU%E4%BB%A3%E7%A0%81"><span class="toc-number">4.1.</span> <span class="toc-text">demo1里NodeMCU代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#demo1%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-number">5.</span> <span class="toc-text">demo1服务器端代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%E8%AF%B4%E6%98%8E"><span class="toc-number">6.</span> <span class="toc-text">补充说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B6%E6%AE%B5%E6%80%A7%E4%BD%9C%E4%B8%9A"><span class="toc-number">7.</span> <span class="toc-text">阶段性作业</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A5%94%E5%90%91demo2"><span class="toc-number">8.</span> <span class="toc-text">奔向demo2</span></a></li></ol></div></div><div class="post-content"><p>&emsp;在阅读本篇文章之前，你已经阅读了：</p>
<ul>
<li><a href="/posts/31494">NodeMCU基础</a></li>
<li><a href="/posts/64786/">demo1跑起来</a></li>
<li><a href="/posts/37707">计算机网络基础</a></li>
<li><a href="/posts/7602">NodeMCU与网络调试助手联调</a></li>
<li><a href="/posts/58215">使用NodeJs实现TCP服务器</a></li>
<li><a href="/posts/54080">HTML、CSS、JS基础</a></li>
<li><a href="/posts/33173">使用NodeJs实现HTTP服务器</a> </li>
<li><a href="/posts/38208">亲手实现demo0.1</a></li>
<li><a href="/posts/27238">Bootstrap基础</a></li>
<li><a href="/posts/22339">Express框架</a></li>
</ul>
<h2 id="本篇视频"><a href="#本篇视频" class="headerlink" title="本篇视频"></a>本篇视频</h2><iframe src="//player.bilibili.com/player.html?aid=462062924&bvid=BV16L411n7Pi&cid=379908862&page=14" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" class="bilibili-video"> </iframe>


<h2 id="本篇学习内容"><a href="#本篇学习内容" class="headerlink" title="本篇学习内容"></a>本篇学习内容</h2><ul>
<li>讲解demo1里服务器端代码、界面代码、NodeMCU代码</li>
<li>阶段性作业：自行实现demo1效果<h2 id="demo1总览"><a href="#demo1总览" class="headerlink" title="demo1总览"></a>demo1总览</h2>&emsp;在之前的<a href="/posts/64786/">demo1跑起来</a>里面已经介绍了demo1跑起来的效果了，这篇不再演示，而是直接讲解代码。（PS：图片中的IP地址根据实际情况变化，图里只是简单地举例。）<br><img src="/blog/blog_images/demo1通信示意.webp" alt="demo1通信示意"><br>&emsp;整个demo1的整体代码流程图如下所示：<br><img src="/blog/blog_images/demo1流程图.webp" alt="demo1流程图"><br>&emsp;首先服务器端的代码要跑起来，整个代码就是由Express手脚架（generator）一健生成的。然后NodeMCU通电跑程序时，首先连接WIFI，连接WIFI成功后会连接TCP服务器，成功后会不断地发送<code>tick</code>数值，我用这个当作心跳（在之前的课程里：<a href="/posts/38208">亲手实现demo0.1</a> 里有讨论过为什么要引入心跳机制），然后一直等待接收控制指令，执行开关灯。<br>&emsp;服务器端跑起来后，可以访问网页界面，点击网页界面的按钮，服务器端程序接收到控制指令，进而转发到对应的硬件里，硬件接收到就执行开关灯。</li>
</ul>
<h2 id="demo1界面代码"><a href="#demo1界面代码" class="headerlink" title="demo1界面代码"></a>demo1界面代码</h2><p>&emsp;demo1的界面极其简单，就是一个下拉框一个表格，两个按钮。界面代码在<code>demo1/myapp/views/index.html</code>，里面有引用的静态文件如<code>&lt;script src=&quot;/javascripts/index.js&quot;&gt;&lt;/script&gt;</code>对应的位置就是在<code>demo1/myapp/public/javascripts/index.js</code>，这个对应着界面的逻辑代码，就是由它来获取在线设备数据，渲染到界面，点击按钮控制在线设备开关灯等业务。<br>&emsp;为了获取在线设备列表，界面每次向服务器端发出一个请求（轮询）,服务端会返回所有的在线设备，格式就是数组，数组晨的每个设备的数据格式对应着<code>&#123;addr:&#39;...&#39;,id:&#39;...&#39;&#125;</code>：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> httpRequest = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>.XMLHttpRequest) &#123; <span class="comment">// Mozilla, Safari, IE7+ ...</span></span><br><span class="line">    httpRequest = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">window</span>.ActiveXObject) &#123; <span class="comment">// IE 6 and older</span></span><br><span class="line">      httpRequest = <span class="keyword">new</span> ActiveXObject(<span class="string">&quot;Microsoft.XMLHTTP&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  httpRequest.onreadystatechange = <span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>( httpRequest.readyState === <span class="number">4</span>)&#123;</span><br><span class="line">      <span class="comment">// 0	UNSENT	代理被创建，但尚未调用 open() 方法。</span></span><br><span class="line">      <span class="comment">// 1	OPENED	open() 方法已经被调用。</span></span><br><span class="line">      <span class="comment">// 2	HEADERS_RECEIVED	send() 方法已经被调用，并且头部和状态已经可获得。</span></span><br><span class="line">      <span class="comment">// 3	LOADING	下载中； responseText 属性已经包含部分数据。</span></span><br><span class="line">      <span class="comment">// 4	DONE	下载操作已完成。</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 删除select里的旧数据（根据类名来找到那些元素）</span></span><br><span class="line">      <span class="keyword">var</span> selectItems = <span class="built_in">document</span>.getElementsByClassName(<span class="string">&#x27;equipment-select-item&#x27;</span>)</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; selectItems.length; i++) &#123;</span><br><span class="line">        selectItems[i].remove()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 删除table里的旧数据（根据类名来找到那些元素）</span></span><br><span class="line">      <span class="keyword">var</span> tableItems = <span class="built_in">document</span>.getElementsByClassName(<span class="string">&#x27;equipment-table-item&#x27;</span>)</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; tableItems.length; i++) &#123;</span><br><span class="line">        tableItems[i].remove()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> responseData = <span class="built_in">JSON</span>.parse(httpRequest.responseText)</span><br><span class="line">      responseData.forEach(<span class="function"><span class="params">equipment</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">// 给select 添加新数据</span></span><br><span class="line">        addSelectorData(equipment)</span><br><span class="line">        <span class="comment">// 给table 添加新数据</span></span><br><span class="line">        addTableData(equipment)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  httpRequest.open(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/equipmentArray&#x27;</span>);</span><br><span class="line">  httpRequest.send();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 马上使用一次。</span></span><br><span class="line">getData()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 每一秒轮询一次</span></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  getData()</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>&emsp;JavaScript能控制界面的变化，本质就是操作DOM对象。新增了一个在线设备，我给下拉框添加一个选择，所以我就创建对应的<code>option</code>元素挂到<code>select</code>元素之下，所以下拉框就多了这个选项：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addSelectorData</span>(<span class="params">equipment</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 给select 添加新数据</span></span><br><span class="line">  <span class="keyword">var</span> selector = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;dev-selector&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> option = <span class="built_in">document</span>.createElement(<span class="string">&#x27;option&#x27;</span>);</span><br><span class="line">  <span class="comment">// 添加这个类名是方便后面删除时定位到这些元素</span></span><br><span class="line">  option.className = <span class="string">&#x27;equipment-select-item&#x27;</span> </span><br><span class="line">  option.innerText = equipment.addr+<span class="string">&#x27; - &#x27;</span>+equipment.id</span><br><span class="line">  selector.append(option)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>&emsp;给按钮绑定一个事件，当点击开灯按钮时就会向服务器端：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">postData</span>(<span class="params">equipment,actionString</span>)</span>&#123;</span><br><span class="line">  <span class="comment">// 发送控制指令</span></span><br><span class="line">  <span class="keyword">if</span>(!equipment)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">console</span>.log(<span class="string">&#x27;没设备，不可发送指令&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> httpRequest = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>.XMLHttpRequest) &#123; <span class="comment">// Mozilla, Safari, IE7+ ...</span></span><br><span class="line">    httpRequest = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">window</span>.ActiveXObject) &#123; <span class="comment">// IE 6 and older</span></span><br><span class="line">      httpRequest = <span class="keyword">new</span> ActiveXObject(<span class="string">&quot;Microsoft.XMLHTTP&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> params = <span class="string">&#x27;action=&#x27;</span>+actionString+<span class="string">&#x27;&amp;addr=&#x27;</span>+equipment.addr+<span class="string">&#x27;&amp;id=&#x27;</span>+equipment.id</span><br><span class="line">  httpRequest.open(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">  httpRequest.setRequestHeader(<span class="string">&#x27;Content-type&#x27;</span>, <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>);</span><br><span class="line">  httpRequest.send(params);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 点击按钮事件</span></span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">&#x27;open&#x27;</span>).onclick = <span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> equipment = getEquipmentInfo()</span><br><span class="line">  postData(equipment,<span class="string">&#x27;open&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h3 id="demo1里NodeMCU代码"><a href="#demo1里NodeMCU代码" class="headerlink" title="demo1里NodeMCU代码"></a>demo1里NodeMCU代码</h3><p>&emsp;NodeMCU里的代码，就是不断尝试连接WIFI，连接成功后不断尝试连接TCP服务器，连接成功发送它的唯一ID，然后进入死循环，一直等待服务器端的控制指令，若有就执行开关灯，若无就发送<code>tick</code>值心跳（数字不断增加）。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (client.connected()) &#123;</span><br><span class="line">  <span class="comment">//      接收到TCP数据</span></span><br><span class="line">  <span class="keyword">if</span> (client.available())</span><br><span class="line">  &#123;</span><br><span class="line">    String line = client.readStringUntil(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (line == <span class="string">&quot;1&quot;</span>) &#123;</span><br><span class="line">      Serial.println(<span class="string">&quot;command:open led.&quot;</span>);</span><br><span class="line">      digitalWrite(LED_BUILTIN, LOW);</span><br><span class="line">      client.print(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (line == <span class="string">&quot;0&quot;</span>) &#123;</span><br><span class="line">      Serial.println(<span class="string">&quot;command:close led.&quot;</span>);</span><br><span class="line">      digitalWrite(LED_BUILTIN, HIGH);</span><br><span class="line">      client.print(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//若没收到TCP数据，每隔一段时间打印并发送tick值</span></span><br><span class="line">    Serial.print(<span class="string">&quot;tem:&quot;</span>);</span><br><span class="line">    Serial.println(tick);</span><br><span class="line">    client.print(tick);</span><br><span class="line">    tick++;</span><br><span class="line">    delay(<span class="number">1000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;在实际使用时，设备往往拥有一个唯一ID，这个ID用来结合业务逻辑的，比如说我把ID值为001001作为广州市里的某一块设备，ID值002001作为中山市里的一块设备，当广州市的板子坏了，需要替换时，我依旧把ID写成001001，那么它就能继续它的业务逻辑。</p>
<h2 id="demo1服务器端代码"><a href="#demo1服务器端代码" class="headerlink" title="demo1服务器端代码"></a>demo1服务器端代码</h2><p>&emsp;整个程序的入口启动文件就是<code>myapp/bin/www</code>，界面的代码是<code>myapp/views/index.html</code>。HTTP服务器就是由Express框架生成的，我们额外添加了TCP服务器的代码<code>myapp/bin/tcp-server.js</code>。<br>&emsp;当浏览器打开网页时，发起HTTP请求（GET /），服务器代码进入到<code>myapp/routes/index.js</code>发送界面文件：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 默认是使用pug模板的，为了减少不必要的学习与降低入门门槛，改使用html。</span></span><br><span class="line">  res.sendFile(<span class="string">&#x27;index.html&#x27;</span>,&#123;<span class="attr">root</span>:path.join(__dirname , <span class="string">&#x27;../views&#x27;</span>)&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><br>&emsp;当使用硬件连接到服务器时，硬件发出的第一条数据成为其设备id，所有数据都会存放到<code>socket.lastValue</code>中。为了防止不同的读者使用同一个设备ID操作时数据串扰，所以我还额外添加了IP地址以区分。在demo0.1直接使用一个tcpClient变量存放对象，所以它只能支持一个设备，现在改进后使用一个数组存放多个设备就支持多个设备了。所有超过心跳时间没有发数据的都会删除设备。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// receive data</span></span><br><span class="line">socket.on(<span class="string">&quot;data&quot;</span>,<span class="function"><span class="params">data</span>=&gt;</span>&#123;</span><br><span class="line"><span class="keyword">let</span> str = addr+<span class="string">&quot; receive: &quot;</span> + data.toString(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">socket.lastValue = data.toString(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line"><span class="built_in">console</span>.log(str)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// demo1中，我们定义了，接收的第一条数据为设备id</span></span><br><span class="line">  <span class="keyword">if</span>(!socket.id)&#123;</span><br><span class="line">	socket.id = data.toString(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">	socket.addr = addr</span><br><span class="line">	addEquipment(socket)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// myapp\bin\tcp-server.js</span></span><br><span class="line"><span class="keyword">const</span> equipmentArray = []</span><br><span class="line"><span class="comment">// 给列表添加设备</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addEquipment</span>(<span class="params">socket</span>) </span>&#123;</span><br><span class="line">	<span class="comment">// 先从列表删除旧的同名连接</span></span><br><span class="line">	deleteEquipment(socket.id,socket.addr)</span><br><span class="line">	equipmentArray.push(socket)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;浏览器发出POST请求后，由服务器端代码<code>myapp/routes/index.js</code>进行处理，找到对应的设备，并发送控制命令，此时硬件接收到命令进行开关灯。根据POST里的body数据：<code>req.body.addr</code>,<code>req.body.id</code>,<code>req.body.action</code>找到对应的设备，转发控制命令数据：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// POST / 控制设备开关灯</span></span><br><span class="line">router.post(<span class="string">&#x27;/&#x27;</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> addr = req.body.addr</span><br><span class="line">  <span class="keyword">let</span> id = req.body.id</span><br><span class="line">  <span class="keyword">let</span> action = req.body.action</span><br><span class="line">  <span class="keyword">if</span>(action === <span class="string">&#x27;open&#x27;</span> || action === <span class="string">&#x27;close&#x27;</span>)&#123;</span><br><span class="line">    tcpServer.sentCommand(id,addr,action)</span><br><span class="line">  &#125;</span><br><span class="line">  res.json(req.body);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><br>&emsp;界面向服务器端发送的值是<code>open</code>字体符串，服务器端根据id与IP地址找到那个硬件（虽然代码上写的是数组可兼容多个设备，但理论上是唯一的，只有一个设备。），并向硬件转发时发的是<code>1</code>:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// myapp\bin\tcp-server.js</span></span><br><span class="line"><span class="comment">// 给设备发送控制命令</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sentCommand</span>(<span class="params">id,addr,command</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> equipments = findEquipment(id,addr)</span><br><span class="line">	<span class="keyword">if</span>(equipments.length === <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(command === <span class="string">&#x27;open&#x27;</span>)&#123;</span><br><span class="line">		equipments.forEach(<span class="function">(<span class="params">socket</span>)=&gt;</span>&#123;</span><br><span class="line">			socket.write(<span class="string">&quot;1&quot;</span>, <span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(command === <span class="string">&#x27;close&#x27;</span>)&#123;</span><br><span class="line">		equipments.forEach(<span class="function">(<span class="params">socket</span>)=&gt;</span>&#123;</span><br><span class="line">			socket.write(<span class="string">&quot;0&quot;</span>, <span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="补充说明"><a href="#补充说明" class="headerlink" title="补充说明"></a>补充说明</h2><p>&emsp;JS代码里时不时可以看到声明变量时使用的是<code>const</code>与<code>let</code>来取代<code>var</code>，那是ES6引入的语法，用来解决<code>var</code>本身的一些缺陷，具体可自行搜索学习。</p>
<h2 id="阶段性作业"><a href="#阶段性作业" class="headerlink" title="阶段性作业"></a>阶段性作业</h2><p>&emsp;光听课以为自己什么都懂，其实只有自己实践过才是真的懂，在实践的过程中才会发现自己不懂的地方。所以请读者自行实现demo1效果，有什么问题请提出来，我会全部解答。</p>
<h2 id="奔向demo2"><a href="#奔向demo2" class="headerlink" title="奔向demo2"></a>奔向demo2</h2><p>&emsp;demo1尽量追求简单入门，所以界面不好看（帅是第一生产力），性能也不足。先说说demo1的问题：</p>
<ul>
<li>HTTP轮询性能低，时效性差（每一秒轮询代表着极限情况下是有可能2秒才得到最新数据）。</li>
<li>界面丑（优化并会引入图表库Echart，实现数据可视化）</li>
<li>不能显示历史数据（引入数据库）</li>
</ul>
<p>&emsp;为了解决以上问题，我们正式奔向demo2。</p>
</div><div class="tags"></div><div id="vcomment"></div><script src="/js/av-min.js"></script><script src="/js/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'dibwgE5SQgKyFS1KqM3C2WmQ-gzGzoHsz',
  appKey:'G24uL9Fw9oNCfheBorc3GjVB',
  placeholder:'欢迎留言交流',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1 pure-u-md-4-4"><div id="footer"><div> <a target="_blank" rel="noopener" href="https://beian.miit.gov.cn">粤ICP备16092003号</a></div></div></div></div><script type="text/javascript" src="/blog/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/blog/js/smartresize.js?v=0.0.0"></script><script type="text/javascript" src="/blog/js/index.js"></script></header></main><script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/blog/live2dw/assets/hijiki.model.json"},"log":false});</script></body></html>