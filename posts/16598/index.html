<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="技术记录与心得分享，及《软硬结合——从零打造物联网》、《3D可视化教程》两个系列教程。"><meta name="baidu-site-verification" content="xsF0k2IpTd"><meta name="360-site-verification" content="17062a868693e9ab70b4c9543d98059b"><meta name="sogou_site_verification" content="VAcZeTHOK4"><meta name="google-site-verification" content="_1T1ah4LkGnFPqgYs6wQqN27O6PfrXJqG8gbFwh7ClM"><title>因编码不一致导致的数据库异常退出 | 生子当如哈士奇的小空间</title><script type="text/javascript" src="/sw-init.js"></script><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/normalize.min.css"><link rel="stylesheet" type="text/css" href="/css/pure-min.css"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><script type="text/javascript" src="/js/jquery-3.3.1.min.js"></script><script type="text/javascript" src="/js/lazyload.8.16.0.min.js"></script><link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css"><script type="text/javascript" src="/js/bootstrap.min.js"></script><link rel="stylesheet" type="text/css" href="/css/bootstrap-treeview.min.css"><script type="text/javascript" src="/js/bootstrap-treeview.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '646acd4e6c74eb119c3d5d93c5bfde70';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><link rel="stylesheet" type="text/css" href="/css/index.css"><script type="text/javascript" src="/js/slideout.min.js"></script><script type="text/javascript" src="/js/image-fullscreen.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><nav class="navbar navbar-default"><div class="container-fluid navbar-custom"><!-- Brand and toggle get grouped for better mobile display--><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="#">导航栏</a></div><!-- Collect the nav links, forms, and other content for toggling--><div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1"><ul class="nav navbar-nav"><li class="dropdown"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">软硬结合——从零打造物联网 <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/posts/44755">导读</a></li><li><a href="/posts/31494">1.NodeMCU基础</a></li><li><a href="/posts/64786">2.demo1跑起来</a></li><li><a href="/posts/64594">3.demo2跑起来</a></li><li><a href="/posts/31687">4.部署到云服务器</a></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">亲手实现demo0.1</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/posts/37707">5.计算机网络基础</a></li><li><a href="/posts/7602">6.NodeMCU与网络调试助手联调</a></li><li><a href="/posts/58215">7.使用NodeJs实现TCP服务器</a></li><li><a href="/posts/54080">8.HTML、CSS、JS基础</a></li><li><a href="/posts/33173">9.使用NodeJs实现HTTP服务器</a></li><li><a href="/posts/38208">10.亲手实现demo0.1     </a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">亲手实现demo1</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/posts/27238">11.Bootstrap基础</a></li><li><a href="/posts/22339">12.Express框架</a></li><li><a href="/posts/24742">13.亲手实现demo1</a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">亲手实现demo2</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/posts/18173">14.数据可视化基础</a></li><li><a href="/posts/21192">15.Websocket协议</a></li><li><a href="/posts/41347">16.数据库基础</a></li><li><a href="/posts/29864">17.亲手实现demo2</a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">其它补充</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/posts/52429">chrome开发者工具</a></li><li><a href="/posts/54436">软硬结合调试技巧</a></li><li><a href="/posts/15341">将demo2制作成微信小程序</a></li><li><a href="/posts/1041">将demo2制作成exe应用程序</a></li><li><a href="/posts/34982">Linux基础</a></li><li><a href="/posts/41995">最后的讨论</a></li></ul></li></ul></li><li class="dropdown"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">3D可视化教程（Web）<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/posts/30679/">导读</a></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">项目示例</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/posts/2544">模型拆解示例</a></li><li><a href="/posts/46791">智慧城市</a></li><li><a href="/posts/15060">地球数据流                  </a></li><li><a href="/posts/19890">数据中心</a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">基础示例</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/posts/42378">1-模型制作与展示</a></li><li><a href="/posts/45270">2-模型数据                 </a></li><li><a href="/posts/5988">3-光线痕迹</a></li><li><a href="/posts/60366">4-动画</a></li><li><a href="/posts/52736">5-显示动态图               </a></li><li><a href="/posts/56155">6-屏幕坐标转换</a></li><li><a href="/posts/48386">7-开关门(不动点)              </a></li><li><a href="/posts/30581">8-聚焦靠近</a></li><li><a href="/posts/59091">9-容量模式           </a></li><li><a href="/posts/62843">10-曲线移动</a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">Blender相关</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/posts/46886">常用操作</a></li><li><a href="/posts/20949">导入城市建筑(.osm)                </a></li><li><a href="/posts/4195">导入城市建筑(.rdc)     </a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">其它</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/posts/31929">3D案例收集</a></li><li><a href="/posts/27566">PS常用技巧              </a></li><li><a href="/posts/47064">PS制作科技感界面  </a></li><li><a href="/posts/5200">three.js性能优化</a></li><li><a href="/posts/1192">线性代数基础知识归纳              </a></li><li><a href="/posts/44479">3D温场效果  </a></li><li><a href="/posts/3280">线框转换效果</a></li></ul></li></ul></li><li class="dropdown"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">杂谈<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/posts/62923/">推荐书籍</a></li><li><a href="/posts/61760/">工具推荐</a></li><li><a href="/posts/44837/">人生一百种失败方法</a></li><li><a href="/posts/25883/">分享当面试官的经验</a></li></ul></li><li><a href="/archives">所有文章<span class="sr-only">(current)</span></a></li><li><a href="/posts/13104">云服务器优惠<span class="sr-only">(current)</span></a></li><li><a href="/posts/23630">关于<span class="sr-only">(current)</span></a></li></ul></div></div></nav><main class="body_container"><header><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-4-4"><div class="content_container"><div class="post"><h1 class="post-title">因编码不一致导致的数据库异常退出</h1><div class="post-meta">Nov 4, 2024<span> | </span><span class="category"><a href="/categories/%E5%90%8E%E7%AB%AF/">后端</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a class="disqus-comment-count" href="/posts/16598/#vcomment"><span class="valine-comment-count" data-xid="/posts/16598/"></span><span> 条评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div></div></div><div class="post-content"><p>&emsp;我使用navicat进行结构对比后，执行部署脚本，试图同步结构，发现执行到某一个语句就会让数据库崩溃，必须手动重启。于是我就开始排查，定位问题定位了老半天。重启数据库后，先用<code>show variables like &#39;%log_error%&#39;;</code>找到数据库的错误日志，报错信息如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">2024-11-01T10:55:40.115637+08:00 39 [ERROR] [MY-000000] [InnoDB] InnoDB: Assertion failure: ut0ut.cc:678:!m_fatal</span><br><span class="line">InnoDB: thread 1616</span><br><span class="line">InnoDB: We intentionally generate a memory trap.</span><br><span class="line">InnoDB: Submit a detailed bug report to http://bugs.mysql.com.</span><br><span class="line">InnoDB: If you get repeated assertion failures or crashes, even</span><br><span class="line">InnoDB: immediately after the mysqld startup, there may be</span><br><span class="line">InnoDB: corruption in the InnoDB tablespace. Please refer to</span><br><span class="line">InnoDB: http://dev.mysql.com/doc/refman/8.0/en/forcing-innodb-recovery.html</span><br><span class="line">InnoDB: about forcing recovery.</span><br><span class="line">02:55:40 UTC - mysqld got exception 0x80000003 ;</span><br><span class="line">This could be because you hit a bug. It is also possible that this binary</span><br><span class="line">or one of the libraries it was linked against is corrupt, improperly built,</span><br><span class="line">or misconfigured. This error can also be caused by malfunctioning hardware.</span><br><span class="line">Attempting to collect some information that could help diagnose the problem.</span><br><span class="line">As this is a crash and something is definitely wrong, the information</span><br><span class="line">collection process might fail.</span><br><span class="line"></span><br><span class="line">key_buffer_size=8388608</span><br><span class="line">read_buffer_size=131072</span><br><span class="line">max_used_connections=92</span><br><span class="line">max_threads=500</span><br><span class="line">thread_count=1</span><br><span class="line">connection_count=1</span><br><span class="line">It is possible that mysqld could use up to </span><br><span class="line">key_buffer_size + (read_buffer_size + sort_buffer_size)*max_threads = 205176 K  bytes of memory</span><br><span class="line">Hope that&#x27;s ok; if not, decrease some variables in the equation.</span><br><span class="line"></span><br><span class="line">Thread pointer: 0x22df1c6d040</span><br><span class="line">Attempting backtrace. You can use the following information to find out</span><br><span class="line">where mysqld died. If you see no messages after this, something went</span><br><span class="line">terribly wrong...</span><br><span class="line">7ff6402ea6d2    mysqld.exe!???</span><br><span class="line">7ffc0997da2d    ucrtbase.dll!raise()</span><br><span class="line">7ffc0997e901    ucrtbase.dll!abort()</span><br><span class="line">7ff640536a67    mysqld.exe!???</span><br><span class="line">7ffc00000003    </span><br><span class="line">7ffc00000003    </span><br><span class="line">194    </span><br><span class="line">7ffc099fa510    ucrtbase.dll!_wctype()</span><br><span class="line">7ff640949210    mysqld.exe!???</span><br><span class="line">80    </span><br><span class="line">37    </span><br><span class="line">7ffb00000040    </span><br><span class="line">7ff6412bc25a    mysqld.exe!???</span><br><span class="line">7ffc00080000    </span><br><span class="line">7ff6412bc1c8    mysqld.exe!???</span><br><span class="line">7ff6412bc59a    mysqld.exe!???</span><br><span class="line">2a6    </span><br><span class="line">7ff64113589c    mysqld.exe!???</span><br><span class="line">7ff6412bce18    mysqld.exe!???</span><br><span class="line">650    </span><br><span class="line">14f    </span><br><span class="line"></span><br><span class="line">Trying to get some variables.</span><br><span class="line">Some pointers may be invalid and cause the dump to abort.</span><br><span class="line">Query (22dcd1dfbc8): ALTER TABLE `test_db`.`test_device` ADD COLUMN `ext_sn` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT &#x27;澶栭儴sn&#x27; AFTER `custom_config`</span><br><span class="line">Connection ID (thread ID): 39</span><br><span class="line">Status: KILL_CONNECTION</span><br><span class="line"></span><br><span class="line">The manual page at http://dev.mysql.com/doc/mysql/en/crashing.html contains</span><br><span class="line">information that should help you find out what is causing the crash.</span><br></pre></td></tr></table></figure>
<p>&emsp;说实话，这报错信息没有太多有效内容，反复定位的过程中，我发现了另一个问题，为什么结构对比有大量的<code>int(0)</code>与<code>int(11)</code>这种差异，而且手动改还不生效。查了一下是原来因为从从8.0.17版本开始，TINYINT, SMALLINT, MEDIUMINT, INT, and BIGINT类型的显示宽度将失效（也确实，这些字段理论上，本身长度就是固定的），而我的两个数据库版本不同，一个是8.0.11，另一个是8.0.29:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MySQL Server 8.0.17 deprecated the display width for the TINYINT, SMALLINT, MEDIUMINT, INT, and BIGINT data types when the ZEROFILL modifier is not used, and MySQL Server 8.0.19 has removed the display width for those data types from results of SHOW CREATE TABLE, SHOW CREATE FUNCTION, and queries on INFORMATION_SCHEMA.COLUMNS, INFORMATION_SCHEMA.ROUTINES, and INFORMATION_SCHEMA.PARAMETERS (except for the display width for signed TINYINT(1)). This patch adjusts Connector/J to those recent changes of MySQL Server and, as a result, DatabaseMetaData, ParameterMetaData, and ResultSetMetaData now report identical results for all the above-mentioned integer types and also for the FLOAT and DOUBLE data types. (Bug #30477722)</span><br></pre></td></tr></table></figure></p>
<p>&emsp;别外把sql语句中的<code>CHARACTER SET utf8 COLLATE utf8_general_ci</code>删掉后，数据库就不会崩溃了。检查了一下数据表的编码格式，果然是因为编码的问题，一个是utf8（等于utf8mb3），另一个是utf8mb4的，是因为编码的问题导致异常。也终于明白了为啥会有<code>澶栭儴</code>这样的乱码字。这下子问题解决了，就是编码的问题，重新调整编码即可。</p>
</div><div class="tags"></div><div id="vcomment"></div><script src="/js/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var serverURLs = 'https://leancloud.scaugreen.cn'
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  serverURLs:serverURLs,
  notify:notify,
  verify:verify,
  appId:'dibwgE5SQgKyFS1KqM3C2WmQ-gzGzoHsz',
  appKey:'G24uL9Fw9oNCfheBorc3GjVB',
  placeholder:'欢迎留言交流',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1 pure-u-md-4-4"><div id="footer"><div> <a target="_blank" rel="noopener" href="https://beian.miit.gov.cn">粤ICP备16092003号</a></div></div></div></div><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script><script type="text/javascript" src="/js/index.js"></script></header></main><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"log":false});</script></body></html>