<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="生子当如哈士奇的个人博客，包含若干技术文章，以及《软硬结合——从零打造物联网》、《3D可视化教程》两个系列教程。"><meta name="baidu-site-verification" content="xsF0k2IpTd"><meta name="360-site-verification" content="17062a868693e9ab70b4c9543d98059b"><meta name="sogou_site_verification" content="VAcZeTHOK4"><meta name="google-site-verification" content="_1T1ah4LkGnFPqgYs6wQqN27O6PfrXJqG8gbFwh7ClM"><script data-ad-client="ca-pub-5955811496112897" async="" src="https://pagead2.googlesyndication.com/pagead/blog/js/adsbygoogle.js"></script><title>基于MQTT协议的通信设计 | 生子当如哈士奇的个人博客</title><meta name="robots" content="noindex"><script type="text/javascript" src="/sw-init.js"></script><link rel="stylesheet" type="text/css" href="/blog/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/blog/css/normalize.min.css"><link rel="stylesheet" type="text/css" href="/blog/css/pure-min.css"><link rel="stylesheet" type="text/css" href="/blog/css/grids-responsive-min.css"><link rel="stylesheet" href="/blog/css/font-awesome.min.css"><script type="text/javascript" src="/blog/js/jquery-3.3.1.min.js"></script><script type="text/javascript" src="/blog/js/lazyload.8.16.0.min.js"></script><link rel="stylesheet" type="text/css" href="/blog/css/bootstrap.min.css"><script type="text/javascript" src="/blog/js/bootstrap.min.js"></script><link rel="stylesheet" type="text/css" href="/blog/css/bootstrap-treeview.min.css"><script type="text/javascript" src="/blog/js/bootstrap-treeview.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><link rel="apple-touch-icon" href="/blog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/blog/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '646acd4e6c74eb119c3d5d93c5bfde70';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><link rel="stylesheet" type="text/css" href="/blog/css/index.css"><script type="text/javascript" src="/blog/js/slideout.min.js"></script><script type="text/javascript" src="/blog/js/image-fullscreen.js"></script><meta name="generator" content="Hexo 5.4.0"></head><body><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/blog/js/totop.js?v=0.0.0" async></script><nav class="navbar navbar-default"><div class="container-fluid navbar-custom"><!-- Brand and toggle get grouped for better mobile display--><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="#">导航栏</a></div><!-- Collect the nav links, forms, and other content for toggling--><div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1"><ul class="nav navbar-nav"><li class="dropdown"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">软硬结合——从零打造物联网 <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/44755">导读</a></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">项目演示</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/38208">demo0.1</a></li><li><a href="/blog/posts/64786">demo1</a></li><li><a href="/blog/posts/64594">demo2</a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">网络通信</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/37707">计算机网络基础</a></li><li><a href="/blog/posts/37286">IP协议基础</a></li><li><a href="/blog/posts/19508">TCP协议基础</a></li><li><a href="/blog/posts/34265">HTTP协议基础</a></li><li><a href="/blog/posts/20945">MQTT协议基础（选学）</a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">客户端开发</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/54080">HTML、CSS、JS基础</a></li><li><a href="/blog/posts/52429">chrome开发者工具</a></li><li><a href="/blog/posts/27238">Jquery、Bootstrap基础</a></li><li><a href="/blog/posts/18173">数据可视化基础</a></li><li><a href="/blog/posts/15341">微信小程序基础</a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">服务器开发</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/56793">NodeJs基础</a></li><li><a href="/blog/posts/34982">Linux基础</a></li><li><a href="/blog/posts/19114">Nginx基础</a></li><li><a href="/blog/posts/41347">数据库基础</a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">硬件</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/32577">ESP8266基础</a></li><li><a href="/blog/posts/31494">nodemcu基础</a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">其它</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/54436">调试技巧</a></li><li><a href="/blog/posts/61760">工具推荐                  </a></li><li><a href="/blog/posts/37993">资源链接汇总</a></li><li><a href="/blog/posts/41995">最后的讨论     </a></li></ul></li></ul></li><li class="dropdown"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">3D可视化教程（Web）<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/30679/">导读</a></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">项目示例</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/2544">a-模型拆解示例</a></li><li><a href="/blog/posts/46791">b-智慧城市                 </a></li><li><a href="/blog/posts/19890">c-数据中心</a></li><li><a href="/blog/posts/3280">d-线框转换效果</a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">基础示例</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/42378">1-模型制作与展示</a></li><li><a href="/blog/posts/45270">2-模型数据                 </a></li><li><a href="/blog/posts/5988">3-光线痕迹</a></li><li><a href="/blog/posts/60366">4-动画</a></li><li><a href="/blog/posts/52736">5-显示动态图               </a></li><li><a href="/blog/posts/56155">6-屏幕坐标转换</a></li><li><a href="/blog/posts/48386">7-开关门(不动点)              </a></li><li><a href="/blog/posts/30581">8-聚焦靠近</a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">Blender相关</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/46886">常用操作</a></li><li><a href="/blog/posts/20949">导入城市建筑(.osm)                </a></li><li><a href="/blog/posts/4195">导入城市建筑(.rdc)     </a></li></ul></li><li class="dropdown-submenu"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="nav-label">其它</span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/31929">3D案例收集</a></li><li><a href="/blog/posts/27566">PS常用技巧              </a></li><li><a href="/blog/posts/47064">PS制作科技感界面  </a></li><li><a href="/blog/posts/5200">three.js性能优化</a></li><li><a href="/blog/posts/1192">线性代数基础知识归纳              </a></li><li><a href="/blog/posts/44479">3D温场效果  </a></li></ul></li></ul></li><li class="dropdown"><a class="dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">杂谈<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="/blog/posts/62923/">推荐书籍</a></li><li><a href="/blog/posts/61760/">工具推荐</a></li><li><a href="/blog/posts/44837/">人生一百种失败方法</a></li><li><a href="/blog/posts/25883/">分享当面试官的经验</a></li></ul></li><li><a href="/archives">所有文章<span class="sr-only">(current)</span></a></li><li><a href="/blog/posts/23630">关于<span class="sr-only">(current)</span></a></li></ul></div></div></nav><main class="body_container"><header><div id="header"><div class="site-name"><h1 class="hidden">基于MQTT协议的通信设计</h1><a id="logo">生子当如哈士奇的个人博客</a><p class="description">生子当如哈士奇的个人博客，包含若干技术文章，以及《软硬结合——从零打造物联网》、《3D可视化教程》两个系列教程。</p></div><div id="nav-menu"></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-4-4"><div class="content_container"><div class="post"><h1 class="post-title">基于MQTT协议的通信设计</h1><div class="post-meta">Feb 3, 2019<script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a class="disqus-comment-count" href="/blog/posts/31151/#vcomment"><span class="valine-comment-count" data-xid="/blog/posts/31151/"></span><span> 条评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E4%B9%8B%E9%97%B4%E5%8F%AF%E7%9B%B4%E6%8E%A5%E9%80%9A%E4%BF%A1"><span class="toc-number">1.</span> <span class="toc-text">硬件之间可直接通信</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B0%E6%96%B9%E6%A1%88%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%96%B0%E9%97%AE%E9%A2%98"><span class="toc-number">2.</span> <span class="toc-text">新方案带来的新问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%B9%E8%BF%9B%E6%96%B9%E6%A1%88"><span class="toc-number">3.</span> <span class="toc-text">改进方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E9%97%AE%E9%A2%98"><span class="toc-number">4.</span> <span class="toc-text">其它问题</span></a></li></ol></div></div><div class="post-content"><p>&emsp;<strong>本文阅读需要有MQTT协议基本使用经验。</strong><br>&emsp;demo1与demo2都是使用TCP协议通信直接来传数据。在TCP协议基础之上，硬件发给服务器的第一条消息被我们定义成设备ID，后续的所有消息都被定义成实时温度值，而服务器发给硬件的消息里0代表关灯，1代表开灯，这些就是我们基于TCP协议的通信设计。同样的，基于MQTT协议我们也可以设计出类似的自定义通信。下面我们将讨论一下基于MQTT协议的通信设计。</p>
<h2 id="硬件之间可直接通信"><a href="#硬件之间可直接通信" class="headerlink" title="硬件之间可直接通信"></a>硬件之间可直接通信</h2><p>&emsp;<strong>MQTT协议一大特点是：通过订阅分布的方式，让硬件之间直接通信。</strong><br>&emsp;我们先假设出一个简单的物联网系统：当【温度传感器a】检测到大于24度时，打开【空调A】制冷（分开的两个硬件设备，两者通过网络来进行通信）。传统的方案是上传温度值给云服务器后端程序，然后由后端程序进行逻辑判断，若符合条件（大于24度）则找出需要控制的硬件（空调A）并发送控制命令消息，如图所示：<br><img src="/blog/blog_images/005BIQVbgy1fztjc0zj79j30vk0drq37.jpg" alt=""><br>&emsp;但是使用了MQTT协议之后，硬件与硬件之间可以直接通信（由硬件自行订阅相关主题），这就意味着，温度传感器可以直接通知空调要制冷，空调也可以直接获取温度传感器的数值自行判断是否制冷，当然也可以按传统方案来，把判断逻辑与寻找需要控制硬件的工作交由云服务器后端程序负责。<br>&emsp;将判断逻辑放到传感器：<br><img src="/blog/blog_images/005BIQVbgy1fztjffn300j30ui0da74r.jpg" alt=""><br>&emsp;将判断逻辑放到空调控制器：<br><img src="/blog/blog_images/005BIQVbgy1fztjfmimthj30vd0dvmxe.jpg" alt=""><br>&emsp;传统方案，将判断逻辑放到云服务器后端程序：<br><img src="/blog/blog_images/005BIQVbgy1fztjk3zbpnj30ub0hkjrr.jpg" alt=""></p>
<p>&emsp;<strong>新方案相对于传统方案，极其有效地减轻云服务器的压力（把压力转移到客户端上），合理使用将会节约大量的成本。</strong></p>
<h2 id="新方案带来的新问题"><a href="#新方案带来的新问题" class="headerlink" title="新方案带来的新问题"></a>新方案带来的新问题</h2><p>&emsp;新方案我并没有实践过，但根据经验，已经能想到它带来的新问题。</p>
<ul>
<li>缺失控制能力<br>传统方案是经由云服务器后端程序控制的，想拦截部分消息就在后端程序里改改就行了，但新方案是无法拦截的，MQTT网关只是转发消息而已。</li>
<li>相对于软件改动，硬件改动成本更大<br>业务改动了（经常出现），按传统方案改改软件代码（后端程序）就行，新方案就需要直接改动硬件的代码（传感器或空调），改动硬件成本是远远大于改动软件成本，一般万不得已不会乱改动硬件。</li>
</ul>
<h2 id="改进方案"><a href="#改进方案" class="headerlink" title="改进方案"></a>改进方案</h2><p>&emsp;上面提到的新方案带来的新问题，改进就需要：1.后端程序能有效控制。2.即使业务改动也不能改动硬件代码。<br>&emsp;新方案是由传感器直接发布控制空调的消息或者由空调直接订阅传感器的数据，改进方案变成了 <strong>由后端程序决定硬件需要订阅什么消息，如何做判断</strong>。这样改进就能既享受新方案减轻云服务器压力的优点，又避开了新方案带来的新问题。<br>&emsp;具体做法简单说一下，硬件代码需要写得灵活一些，如：当【空调A】与MQTT服务器建立连接后，马上发送自己的动作列表：“动作1（制冷）、动作2（停止制冷）”，让后端程序获得此设备的动作列表。管理员根据情况，设置【空调A】订阅【温度传感器a】消息，当其值大于24时，就执行动作1（制冷）。<br>&emsp;由于【空调A】订阅了设置消息，所以就会接收到：“订阅【温度传感器a】消息，当其值大于24时，就执行动作1。”。<br>&emsp;自此，【空调A】就能自行订阅【温度传感器a】的消息，并自行判断，然后执行相对应的动作。当业务改动时，就由管理员修改设置即可。改进方案能够让后端程序实现有效控制，并且能适应业务改动。当然，硬件代码只能做那些简单的判断，比如说大于、小于、等于、真、假等等这几个判断，更复杂的比如说等待客户支付成功才能打开门这种复杂业务逻辑的，可以由后端代码进行判断然后将结果转换成一条简单的MQTT消息发布出来，设置硬件订阅这条消息的值，真或假即可。<br>&emsp;<strong>这个改进方案我暂时没见过有人使用，一来这样设计有点新，有点复杂，二来很少物联网系统连接的设备数量达到一定的量级，为了更低的云服务器成本而使用这样相对复杂、开发成本相对较高的方案（具体需要达到多少设备数量时采用这个改进方案比较划算，暂时还缺乏实践数据所以还无法计算）。</strong><br>&emsp;另外，为了兼容旧硬件，一般会有一个转换网关（在旧硬件与新系统之间的硬件，上面跑着转换代码）。</p>
<h2 id="其它问题"><a href="#其它问题" class="headerlink" title="其它问题"></a>其它问题</h2><p>&emsp;在工作中，使用MQTT协议时遇见了一些问题：消息爆炸（使用限流算法如：令牌桶算法）、消息重复（注意幂等性）等问题，待我更深入研究后再讨论。</p>
<!-- flag of hidden posts --></div><div class="tags"><a href="/blog/tags/MQTT/">MQTT</a></div><div id="vcomment"></div><script src="/blog/js/av-min.js"></script><script src="/blog/js/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'dibwgE5SQgKyFS1KqM3C2WmQ-gzGzoHsz',
  appKey:'G24uL9Fw9oNCfheBorc3GjVB',
  placeholder:'欢迎留言交流',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1 pure-u-md-4-4"><div id="footer">Copyright © 2021 <a href="/blog/." rel="nofollow">生子当如哈士奇的个人博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><script type="text/javascript" src="/blog/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/blog/js/smartresize.js?v=0.0.0"></script><script type="text/javascript" src="/blog/js/index.js"></script></header></main><script src="/blog/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/blog/live2dw/assets/hijiki.model.json"},"log":false});</script></body></html>